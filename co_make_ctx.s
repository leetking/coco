/****************************************************************************************
 *                                                                                      *
 *  ----------------------------------------------------------------------------------  *
 *  |    0    |    1    |    2    |    3    |    4     |    5    |    6    |    7    |  *
 *  ----------------------------------------------------------------------------------  *
 *  |   0x0   |   0x4   |   0x8   |   0xc   |   0x10   |   0x14  |   0x18  |   0x1c  |  *
 *  ----------------------------------------------------------------------------------  *
 *  | fc_mxcsr|fc_x87_cw|       guard       |         R12        |        R13        |  *
 *  ----------------------------------------------------------------------------------  *
 *  ----------------------------------------------------------------------------------  *
 *  |    8    |    9    |   10    |   11    |    12    |    13   |    14   |    15   |  *
 *  ----------------------------------------------------------------------------------  *
 *  |   0x20  |   0x24  |   0x28  |  0x2c   |   0x30   |   0x34  |   0x38  |   0x3c  |  *
 *  ----------------------------------------------------------------------------------  *
 *  |        R14        |        R15        |         RBX        |        RBP        |  *
 *  ----------------------------------------------------------------------------------  *
 *  ----------------------------------------------------------------------------------  *
 *  |   16    |   17    |   18    |   19    |    20    |    21   |    22   |    23   |  *
 *  ----------------------------------------------------------------------------------  *
 *  |   0x40  |   0x44  |                                                            |  *
 *  ----------------------------------------------------------------------------------  *
 *  |        RIP        |                                                            |  *
 *  ----------------------------------------------------------------------------------  *
 *                                                                                      *
 ****************************************************************************************/

/**
 * ctx_t co_make_ctx(void* sp, size_t size, int (*fn)(transfer_t));
 * fn接受transfer_t类型参数
 * @sp %rdi:
 * @size %rsi:
 * @fn %rdx:
 * @return %rax:
 */
.text
.global co_make_ctx
.type co_make_ctx,@function
.align 16
co_make_ctx:
    movq    %rdi, %rax          /* %rdi 栈顶 */
    andq    $-16, %rax          /* 栈对齐16字节 ref: https://stackoverflow.com/questions/49391001/why-does-the-x86-64-amd64-system-v-abi-mandate-a-16-byte-stack-alignment */
    leaq    -0x50(%rax), %rax   /* 分配空间存储ctx, 以及finish的地址 */

    leaq    finish(%rip), %rcx
    movq    %rcx, 0x48(%rax)    /* finish */

    movq    %rdx, 0x40(%rax)    /* fn */
    ret

finish:
    /* xorq %rdi, %rdi */
    /* exit with fn return value */
    movl    %eax, %edi  /* 严格来说int是32位，应该使用eax */
    call    _exit@PLT
    /* 预期不会执行到下面hlt */
    hlt

.size co_make_ctx,.-co_make_ctx
